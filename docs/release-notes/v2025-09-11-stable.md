# Release notes – Stable (2025-09-11)

This document summarizes the changes for the stable drop on 2025-09-11 and includes rollback instructions.

## Overview
- CMS (Strapi) is stable; public READ endpoints are available
- CI/CD (GitHub Actions) fixed and validated end-to-end

## Frontend (Web)
- Next.js app builds on Actions and is deployed via SCP to the server
- Packaging now safely includes optional files only (next.config.js, middleware.ts, next-sitemap.config.js) to avoid tar failures when a file is absent

## CMS (Strapi)
- Override Sharp to 0.34.3 via pnpm overrides (fix native binary issues)
- Add `@strapi/plugin-users-permissions`
- Add routers/services with public read (auth: false) for: products, categories, reviews, faqs
- Fix Category pluralName to `categories` (route now `/api/categories`)
- Ensure upload folder exists: `apps/cms/public/uploads`
- Rebuild admin artifacts

## CI/CD
- Workflow: safe tar for Web artefacts (only include optional files if present)
- Workflow: add Web & CMS health checks after deploy (curl 200)
- Secrets required: `SSH_HOST`, `SSH_USER`, `SSH_PORT`, `SSH_PRIVATE_KEY`

## Verification checklist
- Web
  - `https://b-audio.vn/` → 200
  - `https://b-audio.vn/sitemap.xml` → 200
  - `https://b-audio.vn/products` → 200
- CMS
  - `https://api.b-audio.vn/admin` → 200
  - `https://api.b-audio.vn/api/products` → 200

## Rollback guidance
Preferred approach is re-deploying a previous commit/tag via GitHub Actions.

### A) Rollback via GitHub Actions (recommended)
1. Identify the target commit or tag (e.g. `v2025.09.11`).
2. Trigger the workflow for that revision:
   - Web UI: open the workflow run for that commit and choose **Re-run all jobs**
   - CLI (from an authenticated environment):
     ```bash
     # list recent runs
     gh run list --limit 10
     # re-run a specific run id (example)
     gh run rerun <RUN_ID>
     ```
3. Wait for the pipeline to finish (Deploy Web / Deploy CMS steps will publish the selected revision).
4. Verify endpoints (see checklist above).

### B) Emergency manual rollback (server-side)
Only use when Actions is not available.

- Web
  1) Restart current web to clear cache:
     ```bash
     pm2 restart web && sleep 3
     ```
  2) If you must pin to a specific previous build, prefer re-running Actions. Avoid manual in-place rebuilds unless necessary.

- CMS
  1) Restart CMS:
     ```bash
     pm2 restart cms && sleep 3
     ```
  2) If a database rollback is required, restore from your latest backup (daily cron):
     - Locate your backup script (e.g. `/usr/local/bin/backup.sh`) and follow its restore instructions.
     - After restore, `pm2 restart cms` and verify `/admin` and `/api/products`.

> Notes:
> - Manual git checkout/build on server is discouraged; CI rebuilds are reproducible and safer.
> - Always verify health endpoints after rollback.

## Links
- Release: https://github.com/Chinsusu/b-audio.vn/releases/tag/v2025.09.11
- Actions: https://github.com/Chinsusu/b-audio.vn/actions
